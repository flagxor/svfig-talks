<!DOCTYPE html>
<script src="../websent/websent.js"></script><script>
FONT = 'Courier';
USABLE = 0.9;
//LINE_SPACING = 1.2;
BACKGROUND = '#059';
FOREGROUND = '#fc0';
//BACKGROUND = '#222';
//FOREGROUND = '#cfc';
</script><pre>

     EFORTH
 IMPLEMENTED IN C
         
   Brad Nelson
       üò∑
    Forth Day
November 21, 2020

Hello!

SVFIG

@stenoforth.png
<img src="stenoforth.png">

Presentation Format
  ‚Ä¢ Takahashi Method
    ‚Ä¢ Minimalistic presentation style
    ‚Ä¢ suckless ‚Üí  sent ‚Üí  websent
  ‚Ä¢ Focus on content
    ‚Ä¢ Left justified text
    ‚Ä¢ Full page images

Why C?

    üèóÔ∏è
Compilation

   üìû
 Calling
Convention

LINUX/OSX x64 CONVENTION
             ‚úæ
  Arguments: RDI, RSI, RDX, RCX, R8, R9
  Caller saved: RAX, R10, R11
  Callee saved: RBX, RBP,
                RSP, R12, R13, R14, R15
     16-byte aligned stack, 128 byte red zone

MICROSOFT x64 CONVENTION
             ‚úæ
  Arguments: RCX, RDX, R8, R9
  Caller saved: RAX, R10, R11
  Callee saved: RBX, RBP, RDI, RSI,
                RSP, R12, R13, R14, R15
  16-byte aligned stack, 32-byte shadow space

   üè¢
Structure
 Layout

X-Macros

 #define PRIMITIVE_LIST \
   X("DROP", DROP, tos = *sp; --sp) \
   X("SWAP", SWAP, w = tos; tos = *sp; *sp = w) \
   X("AND", AND, tos = tos & *sp; --sp) \
   X("OR", OR, tos = tos | *sp; --sp) \

 enum {
 #define X(sname, name, code) OP_ ## name,
 PRIMITIVE_LIST
 #undef X
 };

 for (;;) {
   ir = ip[w];
   ++ip;
   switch (ir & 0xff) {
 #define X(sname, name, code) case OP_ ## name: code; break;
     PRIMITIVE_LIST
 #undef X
     default:
       break;
   }
   break;
 }

NOP

90
6690
0f1f00
0f1f4000
0f1f440000
660f1f440000
0f1f8000000000
0f1f840000000000
660f1f840000000000

NOP
66 NOP
NOP DWORD ptr [EAX]
NOP DWORD ptr [EAX + 00H]
NOP DWORD ptr [EAX + EAX*1 + 00H]
66 NOP DWORD ptr [EAX + EAX*1 + 00H]
NOP DWORD ptr [EAX + 00000000H]
NOP DWORD ptr [EAX + EAX*1 + 00000000H]
66 NOP DWORD ptr [EAX + EAX*1 + 00000000H]

Alignment

 #define IDT_NEXT \
   w = (cell_t *) *ip++; \
   x = (cell_t *) *w; \
   goto *x;

 #define DT_NEXT \
   w = (cell_t *) *ip++; \
   goto *w;

 #define CORE_WORDS \
   X(dup, *++sp = tos) \
   X(add, tos += *sp--) \
   X(and, tos &= *sp--) \
   X(or, tos |= *sp--) \
   X(dolit, *++sp = tos; tos = *ip++) \
   X(docolon, *++rp = (cell_t) ip; ip = ((cell_t *) w) + 1) \
   X(doexit, ip = (cell_t *) *rp--) \
   X(load, tos = * (cell_t *) tos) \
   X(store, *(cell_t *) tos = *sp--; tos = *sp--) \

 #define COMMON_REGS \
   register cell_t *ip asm("rdi") = memory; \
   register cell_t *sp asm("rsi") = dstack; \
   register cell_t *rp asm("r9") = rstack; \
   register cell_t tos asm("rbx") = *sp--; \
   register cell_t *w asm("rcx"); \
   int i = 0; \

 #define X(name, code) memory[i++] = (cell_t) && name;
 CORE_WORDS
 #undef X

 #define X(name, code) name: code; IDT_NEXT;
 CORE_WORDS
 #undef X

GCC

 288:   48 89 f0                mov    %rsi,%rax
 28b:   48 8d 76 f8             lea    -0x8(%rsi),%rsi
 28f:   48 23 18                and    (%rax),%rbx
 292:   48 89 f8                mov    %rdi,%rax
 295:   48 8d 7f 08             lea    0x8(%rdi),%rdi
 299:   48 8b 00                mov    (%rax),%rax
 29c:   48 89 c1                mov    %rax,%rcx
 29f:   ff e0                   jmpq   *%rax
 2a1:   0f 1f 80 00 00 00 00    nopl   0x0(%rax)

 120:   48 89 f0                mov    %rsi,%rax
 123:   48 8d 76 f8             lea    -0x8(%rsi),%rsi
 127:   48 23 18                and    (%rax),%rbx
 12a:   e9 51 ff ff ff          jmpq   80 <indirect_threaded+0x80>
 12f:   90                      nop

  80:   48 89 f8                mov    %rdi,%rax
  83:   48 8d 7f 08             lea    0x8(%rdi),%rdi
  87:   48 8b 00                mov    (%rax),%rax
  8a:   48 89 c1                mov    %rax,%rcx
  8d:   48 8b 00                mov    (%rax),%rax
  90:   ff e0                   jmpq   *%rax
  92:   66 0f 1f 44 00 00       nopw   0x0(%rax,%rax,1)

 370:   48 89 f0                mov    %rsi,%rax
 373:   48 89 d7                mov    %rdx,%rdi
 376:   48 8d 76 f8             lea    -0x8(%rsi),%rsi
 37a:   48 23 18                and    (%rax),%rbx
 37d:   e9 66 ff ff ff          jmpq   2e8 <cforth_like+0x18>
 382:   66 0f 1f 44 00 00       nopw   0x0(%rax,%rax,1)

 32a:   4c 23 06                and    (%rsi),%r8
 32d:   eb c1                   jmp    2f0 <cforth_like+0x10>

CLANG

  d0:   48 23 06                and    (%rsi),%rax
  d3:   48 83 c6 f8             add    $0xfffffffffffffff8,%rsi
  d7:   48 8b 0f                mov    (%rdi),%rcx
  da:   48 83 c7 08             add    $0x8,%rdi
  de:   ff 21                   jmpq   *(%rcx)

 240:   48 23 06                and    (%rsi),%rax
 243:   48 83 c6 f8             add    $0xfffffffffffffff8,%rsi
 247:   48 8b 0f                mov    (%rdi),%rcx
 24a:   48 83 c7 08             add    $0x8,%rdi
 24e:   ff e1                   jmpq   *%rcx

 2f0:   48 83 c6 f8             add    $0xfffffffffffffff8,%rsi
 2f4:   48 89 cf                mov    %rcx,%rdi
 2f7:   48 8d 4f 08             lea    0x8(%rdi),%rcx
 2fb:   48 8b 07                mov    (%rdi),%rax
 2fe:   48 83 c0 ff             add    $0xffffffffffffffff,%rax
 302:   48 83 f8 06             cmp    $0x6,%rax
 306:   77 14                   ja     31c <cforth_like+0x3c>
 308:   ff 24 c5 00 00 00 00    jmpq   *0x0(,%rax,8)
 30f:   4c 89 46 08             mov    %r8,0x8(%rsi)
 313:   48 83 c6 08             add    $0x8,%rsi
 317:   48 89 cf                mov    %rcx,%rdi
 31a:   eb db                   jmp    2f7 <cforth_like+0x17>
 31c:   48 89 4a f8             mov    %rcx,-0x8(%rdx)
 320:   48 83 c2 f8             add    $0xfffffffffffffff8,%rdx
 324:   48 8b 7f c8             mov    -0x38(%rdi),%rdi
 328:   eb cd                   jmp    2f7 <cforth_like+0x17>

memory[1] = (cell_t) && and;

and:
  tos &= *sp--;
  NEXT;

         MOVING FORTH
              ‚ù¶
https://www.bradrodriguez.com
           /papers/moving1.htm

DIRECT THREADED
   (IP) -> W   fetch memory pointed by IP into "W" register
   IP+2 -> IP  advance IP (assuming 2-byte addresses)
   JP (W)      jump to the address in the W register

INDIRECT THREADED
   (IP) -> W  fetch memory pointed by IP into "W" register
              ...W now holds address of the Code Field
   IP+2 -> IP advance IP, just like a program counter
              (assuming 2-byte addresses in the thread)
   (W) ->  X  fetch memory pointed by W into "X" register
              ...X now holds address of the machine code 
   JP (X)     jump to the address in the X register

 trees
üå≤üå≤üå≤üå≤
 
 evil
üôàüôâüôä
 
‚ô§ spades
‚ô• hearts
‚ôß clubs
‚ô¶ diamonds

 trees
üå≤üå≤üå≤üå≤

 evil
üôàüôâüôä

‚ô§ spades
‚ô• hearts
‚ôß clubs
‚ô¶ diamonds

QUESTIONS?
    ‚öò
thank you!
