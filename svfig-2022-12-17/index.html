<!DOCTYPE html>
<script src="../websent/websent.js"></script><script>
FONT = 'consolas';
USABLE = 0.9;
LINE_SPACING = 1.2;
BACKGROUND = '#fffff7';
FOREGROUND = '#001';
</script><pre>

    Î¼Eforth
Graphics and Sound
   on the Web
        -- Redux!
       ğŸ™˜
  December 17, 2022

Now
  with
Working
   DEMOS!

 Î¼Eforth
âœ¨ âœ¨ âœ¨
â€¢ Multi-platform eForth based Forth
â€¢ One codebase targets:
  - Windows 32-bit and 64-bit
  - Linux & WSL
  - ESP32 / ESP32-S2/S3 / ESP32-C3 / ESP-CAM
    (known as ESP32forth)
  - Web!

Why the Web?
  ğŸ•¸ ğŸŒ ğŸ•¸
â€¢ Portable, powerful,
   relatively simple I/O APIs.
â€¢ Asm.js, WebAssembly, and JITs
   mean it can go fast!
â€¢ It's easy to show people.
â€¢ It let's people run my code
   without trusting me.  ğŸ™Š

ÂµEForth Approach
       âš“
â€¢ Each opcodes in 1-2 lines of C code
â€¢ Define "system variables" in a C structure
â€¢ Define 5 "core" opcodes
   in larger C functions
    â¥ These could be built from opcodes
    â¥ But avoid needing to "assemble" loops
â€¢ Boot from Forth code in a string

Design Choices
      ğŸ˜
â€¢ Indirect Threaded
    â¥ Single cell VM opcodes
    â¥ Simpler SEE / DOES>
    â¥ Computed goto in C avoids assembly
    â¥ Other models might be faster?
â€¢ Unlimited stacks
â€¢ 32-bit floats only
â€¢ No counted strings

How to bring it to the Web?
    â›µ ğŸŒ ğŸ•¸
â€¢ Convert to Asm.js
    â¥ Hand convert 5 "core" words
    â¥ Automate converting opcodes
      .. with Regexes ğŸ™ƒ ..

Asm.js
 â›µğŸ±
â€¢ Best hack ever
â€¢ Embed C in JavaScript
â€¢ Converted by Chrome
  to WebAssembly

Asm.js
 â›µğŸ±
a = a | 0;  // a is an int
a = fround(a);  // a is a float32
a = (a + 1) | 0;  // ++a;
a = (a + b) | 0;  // a = a + b;
a = imul32(a, b);  // a = a * b;
a = i32[p>>2] | 0;  // a = *p;  (32-bit)
a = u8[p] | 0;  // a = *p;  (8-bit)
return a | 0;  // function returns an int

Bindings to JavaScript
  â›“â›“â›“
jseval! ( a n slot -- )
call ( slot -- )

function(sp) {
  var tos = i32[sp>>2]; sp -= 4;
  // do something with tos
  return sp;
}

Bindings to JavaScript
  â›“â›“â›“
jseval ( a n -- )

r~
  // Run a bunch of JavaScript!
~ jseval

Bindings to JavaScript
  â›“â›“â›“
JSWORD: myword { }
  // Do something in JS
~

Arguments to JavaScript
  ğŸ˜ ğŸ˜ 
JSWORD: my+ { a b -- n }
  return a + b;
~

Multiple Return
    ğŸ¶ğŸ¶ğŸ¶
JSWORD: myswap { a b -- n n }
  return [b, a];
~

Graphics
  ğŸ·ğŸ·
gr ( -- ) Enter graphics mode
text ( -- ) Text mode
show-text ( f -- ) Show/hide text
viewport@ ( -- w h )
window ( w h -- )

Input
 ğŸ­
mouse ( -- x y )
button ( -- b )

Color
ğŸŸ  ğŸŸ¡ ğŸŸ¢ ğŸŸ£
color! ( rgb -- )
$ff0000 constant red
$ffff00 constant yellow
$0000ff constant blue

Drawing
 ğŸ¨ ğŸ¨
box ( x y w h -- )
line ( x1 y1 x2 y2 -- )
font ( a n -- )
fillText ( str str# x y -- )

Paths
ğŸš§ ğŸš§
lineWidth ( w -- )
beginPath ( -- )
moveTo ( x y -- )
lineTo ( x y -- )
quarticCurveTo ( cx cy x y -- )
stroke ( -- )
fill ( -- )

Transforms
 ğŸ¤–ğŸ¤–ğŸ¤–
translate ( x y -- )
scale ( sx sy div -- )
rotate ( angle div -- )
gpush ( -- ) Push transform stack
gpop ( -- ) Push transform stack

Sound
ğŸ”Š ğŸ”Š
tone ( note[midi] volume[0-100] voice[0-7] )
silence ( -- )

       DEMO
eforth.appspot.com

QUESTIONS?
   ğŸµ
 Thank you!
